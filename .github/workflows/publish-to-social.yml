name: Publish Blog Post to Social Media

on:
  push:
    branches: [main, master]
    paths:
      - 'content/blog/*.mdx'
  workflow_dispatch:
    inputs:
      post_slug:
        description: 'Blog post slug to publish (without .mdx)'
        required: true
        type: string

jobs:
  detect-new-post:
    runs-on: ubuntu-latest
    outputs:
      new_post: ${{ steps.check.outputs.new_post }}
      post_slug: ${{ steps.check.outputs.post_slug }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect new blog post
        id: check
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "new_post=true" >> $GITHUB_OUTPUT
            echo "post_slug=${{ inputs.post_slug }}" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          NEW_POST=$(git diff --name-only HEAD~1 HEAD | grep '^content/blog/.*\.mdx$' | head -1)
          
          if [ -n "$NEW_POST" ]; then
            SLUG=$(basename "$NEW_POST" .mdx)
            echo "new_post=true" >> $GITHUB_OUTPUT
            echo "post_slug=$SLUG" >> $GITHUB_OUTPUT
            echo "âœ… New post detected: $SLUG"
          else
            echo "new_post=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No new blog post detected"
          fi

  publish-to-social:
    needs: detect-new-post
    if: needs.detect-new-post.outputs.new_post == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Preflight - validate post exists
        run: |
          POST_FILE="content/blog/${{ needs.detect-new-post.outputs.post_slug }}.mdx"
          if [ ! -f "$POST_FILE" ]; then
            echo "âŒ Post file not found: $POST_FILE"
            exit 1
          fi
          echo "âœ“ Post found: $POST_FILE"

      - name: Preflight - validate frontmatter
        run: |
          node -e '
          const fs = require("fs");
          const slug = process.env.POST_SLUG;
          const file = "content/blog/" + slug + ".mdx";
          const content = fs.readFileSync(file, "utf8");
          const match = content.match(/^---\n([\s\S]+?)\n---/);
          if (!match) { console.error("âŒ Missing frontmatter"); process.exit(1); }
          const fm = {};
          match[1].split("\n").forEach(line => {
            const [key, ...rest] = line.split(":");
            if (key && rest.length) fm[key.trim()] = rest.join(":").trim().replace(/^"|"$/g, "").replace(/^'|'$/g, "");
          });
          const required = ["title","description","date","author","category","image","lang"];
          const missing = required.filter(k => !fm[k]);
          if (missing.length) { console.error("âŒ Missing frontmatter fields:", missing.join(", ")); process.exit(1); }
          if (fm.title.length > 60) { console.error("âŒ Title too long (>60 chars)"); process.exit(1); }
          if (fm.description.length < 120 || fm.description.length > 160) { console.error("âŒ Description length must be 120-160 chars"); process.exit(1); }
          if (!/^https:\/\//.test(fm.image)) { console.error("âŒ Image must be a valid https URL"); process.exit(1); }
          if (fm.lang !== "es" && fm.lang !== "en") { console.error("âŒ lang must be \"es\" or \"en\""); process.exit(1); }

          const isEnFile = slug.endsWith("-en");
          if (isEnFile && fm.lang !== "en") { console.error("âŒ File name ends with -en but lang is not \"en\""); process.exit(1); }
          if (!isEnFile && fm.lang !== "es") { console.error("âŒ File name without -en must have lang \"es\""); process.exit(1); }

          const baseSlug = isEnFile ? slug.replace(/-en$/, "") : slug;
          const esFile = "content/blog/" + baseSlug + ".mdx";
          const enFile = "content/blog/" + baseSlug + "-en.mdx";
          if (!fs.existsSync(esFile) || !fs.existsSync(enFile)) {
            console.error("âŒ Missing language pair. Expected both:", esFile, "and", enFile);
            process.exit(1);
          }
          console.log("âœ“ Frontmatter validated");
          '
        env:
          POST_SLUG: ${{ needs.detect-new-post.outputs.post_slug }}

      - name: Preflight - validate image URL
        run: |
          IMAGE_URL=$(node -e 'const fs=require("fs");const slug=process.env.POST_SLUG;const c=fs.readFileSync("content/blog/"+slug+".mdx","utf8");const m=c.match(/^---\n([\s\S]+?)\n---/);const fm={};m[1].split("\n").forEach(l=>{const [k,...r]=l.split(":");if(k&&r.length)fm[k.trim()]=r.join(":").trim().replace(/^"|"$/g,"").replace(/^'"'"'|'"'"'$/g,"");});console.log(fm.image);')
          if [ -z "$IMAGE_URL" ]; then
            echo "âŒ No image URL found"
            exit 1
          fi
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -I "$IMAGE_URL")
          if [ "$STATUS" -lt 200 ] || [ "$STATUS" -ge 400 ]; then
            echo "âŒ Image URL not reachable: $IMAGE_URL (HTTP $STATUS)"
            exit 1
          fi
          echo "âœ“ Image URL reachable"
        env:
          POST_SLUG: ${{ needs.detect-new-post.outputs.post_slug }}

      - name: Preflight - validate required secrets
        run: |
          FAIL=0

          if [ "${{ vars.ENABLE_LINKEDIN }}" = "true" ] && [ -z "${{ secrets.LINKEDIN_ACCESS_TOKEN }}" ]; then
            echo "âŒ Missing LINKEDIN_ACCESS_TOKEN (ENABLE_LINKEDIN=true)"
            FAIL=1
          fi

          if [ "${{ vars.ENABLE_FACEBOOK }}" = "true" ]; then
            if [ -z "${{ secrets.FACEBOOK_PAGE_ACCESS_TOKEN }}" ]; then
              echo "âŒ Missing FACEBOOK_PAGE_ACCESS_TOKEN (ENABLE_FACEBOOK=true)"
              FAIL=1
            fi
            if [ -z "${{ secrets.FACEBOOK_PAGE_ID }}" ]; then
              echo "âŒ Missing FACEBOOK_PAGE_ID (ENABLE_FACEBOOK=true)"
              FAIL=1
            fi
          fi

          if [ "${{ vars.ENABLE_TELEGRAM }}" = "true" ]; then
            if [ -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]; then
              echo "âŒ Missing TELEGRAM_BOT_TOKEN (ENABLE_TELEGRAM=true)"
              FAIL=1
            fi
            if [ -z "${{ secrets.TELEGRAM_CHANNEL_ID }}" ]; then
              echo "âŒ Missing TELEGRAM_CHANNEL_ID (ENABLE_TELEGRAM=true)"
              FAIL=1
            fi
          fi

          if [ "$FAIL" -eq 1 ]; then
            echo "\nAction: Add missing secrets/variables in GitHub Settings â†’ Secrets and variables â†’ Actions."
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Publish to LinkedIn
        if: ${{ vars.ENABLE_LINKEDIN == 'true' }}
        env:
          LINKEDIN_ACCESS_TOKEN: ${{ secrets.LINKEDIN_ACCESS_TOKEN }}
          POST_SLUG: ${{ needs.detect-new-post.outputs.post_slug }}
        run: node scripts/publish-linkedin.js

      - name: Publish to Facebook
        if: ${{ vars.ENABLE_FACEBOOK == 'true' }}
        env:
          FACEBOOK_PAGE_ACCESS_TOKEN: ${{ secrets.FACEBOOK_PAGE_ACCESS_TOKEN }}
          FACEBOOK_PAGE_ID: ${{ secrets.FACEBOOK_PAGE_ID }}
          POST_SLUG: ${{ needs.detect-new-post.outputs.post_slug }}
        run: node scripts/publish-facebook.js

      - name: Publish to Telegram
        if: ${{ vars.ENABLE_TELEGRAM == 'true' }}
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
          POST_SLUG: ${{ needs.detect-new-post.outputs.post_slug }}
        run: node scripts/publish-telegram.js

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Blog Post Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Post:** ${{ needs.detect-new-post.outputs.post_slug }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Published to:**" >> $GITHUB_STEP_SUMMARY
          [ "${{ vars.ENABLE_LINKEDIN }}" = "true" ] && echo "- âœ… LinkedIn" >> $GITHUB_STEP_SUMMARY || echo "- â­ï¸ LinkedIn (disabled)" >> $GITHUB_STEP_SUMMARY
          [ "${{ vars.ENABLE_FACEBOOK }}" = "true" ] && echo "- âœ… Facebook" >> $GITHUB_STEP_SUMMARY || echo "- â­ï¸ Facebook (disabled)" >> $GITHUB_STEP_SUMMARY
          [ "${{ vars.ENABLE_TELEGRAM }}" = "true" ] && echo "- âœ… Telegram" >> $GITHUB_STEP_SUMMARY || echo "- â­ï¸ Telegram (disabled)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All preflight checks passed and publish steps completed." >> $GITHUB_STEP_SUMMARY

      - name: Failure summary
        if: failure()
        run: |
          echo "## âŒ Social publish failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Post:** ${{ needs.detect-new-post.outputs.post_slug }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next actions:**" >> $GITHUB_STEP_SUMMARY
          echo "1) Review logs for the failed step." >> $GITHUB_STEP_SUMMARY
          echo "2) Fix missing/expired tokens or permissions." >> $GITHUB_STEP_SUMMARY
          echo "3) Re-run the workflow manually with the same slug." >> $GITHUB_STEP_SUMMARY
